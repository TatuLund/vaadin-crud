<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Commercial Vaadin Add-On License 3.0, available at http://vaadin.com/license/cval-3.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-form-layout/src/vaadin-form-layout.html">
<link rel="import" href="../../vaadin-text-field/src/vaadin-text-field.html">
<link rel="import" href="vaadin-crud-include-mixin.html">

  <script>
    (function() {

      /**
       * `<vaadin-crud-form>` is a <vaadin-form-layout> which automatically can configures all its items based
       * on the JSON structure of the first item set.
       *
       * You cannot manually configure fields but you can still style the layout as it's described in
       * `<vaadin-form-layout>` [Documentation](https://vaadin.com/components/vaadin-form-layout/html-api/elements/Vaadin.FormLayoutElement)
       *
       * @memberof Vaadin
       * @mixes Vaadin.Crud.IncludedMixin
       */
      class CrudFormElement extends Vaadin.Crud.IncludedMixin(class extends Vaadin.FormLayoutElement {}) {
        static get is() {
          return 'vaadin-crud-form';
        }

        static get properties() {
          return {
            /**
             * The item being edited.
             */
            item: Object,
            config: Array,
            /**
             *
             */
            __default: {
              type: Array,
              value: [
                  {
                    valueMatch: '^\\d+\\.\\d+$',
                    properties: {
                      'focusElement.type': 'number',
                      'focusElement.step': 0.01,
                      'preventInvalidInput': true
                    }
                  },
                  {
                    valueMatch: '^\\d+$',
                    properties: {
                      'focusElement.type': 'number',
                      'focusElement.step': 1,
                      'preventInvalidInput': true
                    }
                  },
                  {
                    valueMatch: '^https?://',
                    properties: {
                      'focusElement.type': 'url'
                    }
                  },
                  {
                    valueMatch: '^\\w+@\\w+\\.\\w+$',
                    properties: {
                      'focusElement.type': 'email'
                    }
                  },
                  {
                    valueMatch: '^(\\d{1,2}\/\\d{1,2}\/\\d{4}|\\d{4}\-\\d{1,2}\-\\d{1,2})$',
                    element: 'vaadin-date-picker'
                  },
                  {
                    name: 'password',
                    element: 'vaadin-password-field'
                  },
                  {
                    valueMatch: '^(true|false)$',
                    element: 'vaadin-checkbox'
                  }
                ]
              }
            };
          }

        static get observers() {
          return ['__onItemChange(item)'];
        }

        /**
         * Autogenerate form fields based on the JSON structure of the object provided.
         *
         * If not called, the method will be executed the first time an item is assigned.
         */
        _configure(object) {
          this.innerHTML = '';
          this._fields = [];
          this.__createFields(this, object);
          this.notifyResize();
        }

        __onItemChange(item) {
          if (!this._fields) {
            this._configure(item);
          }
        }

        __getField(path, prop, value) {
          let cfg = (this.config || []).concat(this.__default).reduce((ret, cfg) => {
            if (!ret) {
              const rexp = RegExp(cfg.nameMatch || `^${cfg.name || ''}$`);
              if (prop == 'price')  debugger;
              if (cfg.name === prop ||
                  cfg.nameMatch && RegExp(cfg.nameMatch, 'i').test(prop) ||
                  cfg.valueMatch && RegExp(cfg.valueMatch, 'i').test(value)) {
                ret = cfg;
              }
            }
            return ret;
          }, undefined);

          const elem = document.createElement(cfg && cfg.element || 'vaadin-text-field');
          if (cfg) {
            Polymer.RenderStatus.afterNextRender(elem, () => {
              Object.keys(cfg.properties ||Â {}).forEach(p => {
                this.set(p, cfg.properties[p], elem);
              });
            });
          }

          const label = cfg && cfg.label || this.__capitalize(path);
          elem.textContent = label;
          elem.label = label;
          elem.path = path;
          elem.required = cfg && cfg.required !== undefined ? cfg.required : true;
          return elem;
        }

        __createField(parent, path, prop, value) {
          let field;
          field = this.__getField(path, prop, value);
          parent.appendChild(field);
          this._fields.push(field);
          return field;
        }

        __createFields(parent, object, path) {
          Object.keys(object).forEach(prop => {
            if (!this.include && this.exclude && this.exclude.test(prop)) {
              return;
            }
            const newPath = (path ? `${path}.` : '') + prop;
            if (object[prop] && typeof object[prop] === 'object') {
              this.__createFields(parent, object[prop], newPath);
            } else {
              this.__createField(parent, newPath, prop, object[prop]);
            }
          });
          if (!this._fields.length) {
            this._fields = undefined;
          }
        }

        __capitalize(path) {
          return path.toLowerCase().replace(/([^\w]+)/g, ' ').trim().replace(/^./, c => c.toUpperCase());
        }

        __set(path, val, obj) {
          if (obj && path) {
            path.split('.').slice(0, -1).reduce((o, p) => (o[p] = o[p] || {}), obj);
            this.set(path, val, obj);
          }
        }
      }

      customElements.define(CrudFormElement.is, CrudFormElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.CrudFormElement = CrudFormElement;
    })();
  </script>
